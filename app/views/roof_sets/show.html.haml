%p#notice
  = notice

.roof_sets
  %p
    = link_to 'Roof sets', roof_sets_path
  %p
    %h1{style: "margin-bottom: 0; padding-bottom: 0;"}
      = @roof_set.name
    %div{style: ""}
      Across all roofs in set: 
      %span{style: "font-weight: bold;"}
        #{number_with_delimiter( @total_square_ft )}
      sq ft &nbsp;&#183;&nbsp;
      %span{style: "font-weight: bold;"}
        #{number_with_delimiter( (@total_square_ft * @watts_per_sq_ft) / 1000 )}
      kW &nbsp;&#183;&nbsp;
      %span{style: "font-weight: bold;"}
        #{number_with_delimiter( (@total_square_ft * @watts_per_sq_ft * @total_sunglight_hrs) / 1000)}
      kWh
    
  .building-list
    - if @roof_set.description.present?
      %p
        = @roof_set.description
    
    - if @buildings.present?
      %table#schools
        %thead
          %th
          %th School
          %th{style: 'width: 60px;'} sq ft
          %th{style: 'width: 50px;'} kW
          -# %td hrs yr
          %th kWh/yr
          %th $/yr
        - @buildings.each do |building|
          - color = (building.latitude.present? ? '#EAFAF1' : '#FADBD8')
          - kW = building.roof_sq_feet.present? ? (building.roof_sq_feet * @watts_per_sq_ft) / 1000 : nil
          - kWh = kW.present? && building.sunlight_hours.present? ? ((building.roof_sq_feet * @watts_per_sq_ft) / 1000) * building.sunlight_hours : nil
          - savings = kWh.present? ? kWh * 0.17 : nil
          %tr{style: "background-color: #{color}"}
            %td
              = link_to '<i class="fa fa-pencil" aria-hidden="true"></i>'.html_safe, edit_building_path(building), target: "_blank"
            %td
              = link_to building.name, building_path(building), onmouseover: "Gmaps.selectMarker(#{building.id});"
            %td
              = number_with_delimiter( building.roof_sq_feet )
            %td
              = number_with_delimiter( kW )
          
            -# %td
            -#   = number_with_delimiter( building.sunlight_hours )
          
            %td
              = number_with_delimiter( kWh )
            %td
              = number_to_currency( savings, precision: 0 )
          

    -# = link_to 'Edit', edit_roof_set_path(@roof_set)

  .map
    #map
  
<script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.0.1/tablesort.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.0.1/sorts/tablesort.number.min.js"></script>
:javascript
  new Tablesort(document.getElementById('schools'));
  
<script src="//maps.google.com/maps/api/js?key=AIzaSyAJoobIwAnEv4Uk7fHioWEVTtyBrv02DfA"></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>

:javascript
  handler = Gmaps.build('Google');
  handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
    markers = handler.addMarkers(#{raw @marker_hash.to_json});
    Gmaps.store = {} // Initialize storage
    Gmaps.store.markers = markers.map(function(m) {
      marker = handler.addMarker(m);
      marker.serviceObject.set('id', m.id); // You can add other attributes using set
      return marker;
    });
    handler.bounds.extendWith(markers);
    handler.fitMapToBounds();
  });
  
  // https://github.com/apneadiving/Google-Maps-for-Rails/wiki/Adding-an-id-to-markers-and-access-them-later
  Gmaps.selectMarker = function(id) {
    console.log('id moused over: ' + id);
    $.each(Gmaps.store.markers, function() {
      console.log('this.serviceObject.id: ' + this.serviceObject.id);
      if (this.serviceObject.id == id) {
        console.log('match!');
        this.panTo();
        this.serviceObject.setAnimation(google.maps.Animation.BOUNCE);
      } else {
        console.log('no match :-(');
        this.serviceObject.setAnimation(null);
      }}
    );
  }
  